#include "exploitationdialog.h"
#include "ui_exploitationdialog.h"

namespace {
KTable& table = MainWindow::table;
}

ExploitationDialog::ExploitationDialog(QWidget *parent) :
    QDialog(parent),
    ui(new Ui::ExploitationDialog)
{
    ui->setupUi(this);
    init();
    if (MainWindow::currentId >= 0)
        setValues();
}

ExploitationDialog::~ExploitationDialog()
{
    delete ui;
}

void ExploitationDialog::init()
{
    QString car;
    cars.clear();
    unsigned idk, ids, i;
    i = 0;
    ui->CBcar->insertItem(i++, "");
    for (auto& x: table.car)
    {
        ids = x.idcar;
        cars.push_back(ids);
        idk = table.CarById(ids).idclient;

        car = table.ClientById(idk).surname + " " +
              table.ClientById(idk).name + " - " +
              table.BrandById(table.ModelById(table.CarById(ids).idmodel).idbrand).name + " " +
              table.ModelById(table.CarById(ids).idmodel).name;
        ui->CBcar->insertItem(i++, car);
    }
    ui->DEdate->setDisplayFormat("yyyy-MM-dd");
    ui->DEdate->setDate(QDate::currentDate());
}

void ExploitationDialog::setValues()
{
     // qDebug() << "ExpDial 1";
    Exploitation& exp = table.ExploitationById(MainWindow::currentId);
     // qDebug() << "ExpDial 2";
    ui->CBcar->setCurrentIndex(exp.idcar);
     // qDebug() << "ExpDial 3";
    ui->LEoil->setText(exp.oil);
    ui->LEfol->setText(exp.oil_filter);
    ui->LEfpa->setText(exp.fuel_filter);
    ui->LEfpo->setText(exp.air_filter);
    ui->LEfka->setText(exp.cabin_filter);
     // qDebug() << QVariant(exp.mileage).toString();
    ui->LEmileage->setText(QVariant(exp.mileage).toString());
    ui->DEdate->setDate(QDate::fromString(exp.date, "yyyy-MM-dd"));
    ui->LEnote->setText(exp.oil);
     // qDebug() << "ExpDial 4";
}

void ExploitationDialog::on_PBok_clicked()
{
    int i = ui->CBcar->currentIndex();
    if (i < 1)
    {
        QMessageBox::information(this, "Niepoprawne dane", "Pole samochód nie może zostać puste");
        return;
    }
    else if( ui->LEoil->text() == "" && ui->LEfol->text() == "" &&
             ui->LEfpa->text() == "" && ui->LEfpo->text() == "" &&
             ui->LEfka->text() == "" && ui->LEmileage->text() == "" &&
             ui->DEdate->text() == "" && ui->LEnote->text() == "" )
    {
        QMessageBox::information(this, "Niepoprawne dane", "Wszystkie pola nie mogą zostać puste");
        return;
    }
    Exploitation eks;
    eks.idcar = cars[--i];
    eks.oil = ui->LEoil->text();
    eks.oil_filter = ui->LEfol->text();
    eks.fuel_filter = ui->LEfpa->text();
    eks.air_filter = ui->LEfpo->text();
    eks.cabin_filter = ui->LEfka->text();
    eks.mileage = QVariant(ui->LEmileage->text()).toInt();
    eks.date = ui->DEdate->text();
    eks.note = ui->LEnote->text();
    MainWindow::login.addExploitation(eks, MainWindow::currentId);
    this->close();
}

void ExploitationDialog::on_PBanuluj_clicked()
{
    this->close();
}
